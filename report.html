<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report a Civic Issue</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 30px;
        }

        .container {
            max-width: 500px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: auto;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }

        input,
        select,
        textarea,
        button {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            margin-top: 20px;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Report a Civic Issue</h2>

        <label>Description</label>
        <textarea id="description" placeholder="Describe the problem (e.g., Pothole on Main St)..."></textarea>

        <label>Department</label>
        <select id="department">
            <option value="">Select Department</option>
            <option value="Water Supply">Water Supply</option>
            <option value="Roads">Roads</option>
            <option value="Garbage">Garbage</option>
            <option value="Electricity">Electricity</option>
        </select>

        <label>Urgency</label>
        <select id="urgency">
            <option value="">Select Urgency</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
        </select>

        <label>Upload Image üì∏</label>
        <input type="file" id="imageFile" accept="image/*">

        <button id="submitBtn">
            <span id="btnText">Submit Issue</span>
            <span id="spinner" class="spinner">‚è≥ Uploading... Please Wait</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAK3MdF8MKCClWra5sK9bxAbIz5p82igQo",
            authDomain: "ai-civic-issue-reporter-2.firebaseapp.com",
            projectId: "ai-civic-issue-reporter-2",
            storageBucket: "ai-civic-issue-reporter-2.firebasestorage.app",
            messagingSenderId: "730468321462",
            appId: "1:730468321462:web:4532b50322c7556bf4fe17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. ImgBB Upload Function
        async function uploadImageToImgBB(file) {
            // ‚ö†Ô∏è REPLACE THE KEY BELOW WITH YOUR REAL API KEY
            const apiKey = "PASTE_YOUR_IMGBB_API_KEY_HERE";
            const formData = new FormData();
            formData.append("image", file);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            if (!data.success) throw new Error("Image upload failed");
            return data.data.url;
        }

        // 3. Submit Handler
        document.getElementById("submitBtn").addEventListener("click", async () => {
            const description = document.getElementById("description").value.trim();
            const department = document.getElementById("department").value;
            const urgency = document.getElementById("urgency").value;
            const fileInput = document.getElementById("imageFile");
            const file = fileInput.files[0];

            const btn = document.getElementById("submitBtn");
            const btnText = document.getElementById("btnText");
            const spinner = document.getElementById("spinner");

            // Simple Validation
            if (!description || !department || !urgency || !file) {
                alert("Please fill all fields and upload a photo.");
                return;
            }

            try {
                // UI: Start Loading
                btn.disabled = true;
                btnText.style.display = "none";
                spinner.style.display = "inline";

                // Step A: Upload Image
                const imageUrl = await uploadImageToImgBB(file);

                // Step B: Get Location (optional fallback)
                let location = { lat: 12.9716, lng: 77.5946 }; // Default (Bangalore)
                try {
                    const pos = await new Promise((res, rej) => {
                        navigator.geolocation.getCurrentPosition(res, rej, { timeout: 5000 });
                    });
                    location = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                } catch (e) {
                    console.warn("Location not found, using default.");
                }

                // Step C: Save to Firestore
                const issueData = {
                    user_description: description,
                    timestamp: new Date().toISOString(),
                    status: "pending",
                    image_url: imageUrl,
                    location: location,
                    ai_analysis: {
                        department: department,
                        urgency: urgency
                    }
                };

                await addDoc(collection(db, "issues"), issueData);

                alert("‚úÖ Issue reported successfully!");

                // Reset Form
                document.getElementById("description").value = "";
                document.getElementById("department").value = "";
                document.getElementById("urgency").value = "";
                fileInput.value = "";

            } catch (err) {
                console.error(err);
                alert("‚ùå Error: " + err.message);
            } finally {
                // UI: Stop Loading
                btn.disabled = false;
                btnText.style.display = "inline";
                spinner.style.display = "none";
            }
        });
    </script>

</body>

</html>